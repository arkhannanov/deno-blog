#### 2023-09-20

# Testing Fresh Components, Middleware and Handlers with fresh-testing-library

The [`fresh-testing-library`](https://deno.land/x/fresh_testing_library) is a new unit testing utility for Deno Fresh. Until now testing a Fresh application used the built-in Deno test runner with `std/testing` utilities for verifying low-level logic and the [Deno-Puppeteer](https://deno.land/x/puppeteer) or [Astral](https://astral.deno.dev/) libs for end-to-end testing. The `fresh-testing-library` fills the niche between the other options to allow isolated testing of fresh components, middleware and route handlers.

`fresh-testing-library` is a thin wrapper around the [Preact Testing Library](https://preactjs.com/guide/v10/preact-testing-library/) which is inspired by the React Testing Library. All of them including `fresh-testing-library` share an API under the [Testing Library](https://testing-library.com/) moniker.

The Testing Library philosophy is to create tests that interact with the application the same way an app user would do. To do so, Testing Library tests hone in on verifying DOM elements.

Testing library also focusses on accessibility, offering a number of functions to find elements by accessible attributes.

The `fresh-testing-library` is registered as a Deno third party library under the URL "https://deno.land/x/fresh_testing_library". It's component testing feature is a thin wrapper around the Preact Testing Library.

## Setting up a fresh-testing-library component test

Using `fresh-testing-library` for a component test requires the use of the Deno test runner and the `bdd.ts` submodule of the testing module of the Deno standard library. The `bdd` module adds functions that are familiar to testing in Node.js using libraries like [Jest](https://jestjs.io/) or [Mocha](https://mochajs.org/). They include `describe`, `it`, `beforeAll`, `afterAll`, `beforeEach` and `afterEach`.

Here is a simple example of a `fresh-testing-library` component test:
```ts
import { cleanup, fireEvent, render, setup } from "https://deno.land/x/fresh_testing_library";
import { afterEach, beforeAll, describe, it } from "https://deno.land/std/testing/bdd.ts";
import { assertEquals, assertExists } from "https://deno.land/std/assert/mod.ts";
import Todo from "../islands/Todo.tsx";

describe("Todo.tsx test", () => {
  // setup the jsdom environment
  beforeAll(setup);
  // unmount rendered component after each test
  afterEach(cleanup);

  it("should display todo...", () => {
    // assign the component's text content via a prop
    const text = "Foo";
    // render a component's markup
    const screen = render(<Todo text={text} index={1}/>);
    // find an HTML element using the rendered text content
    const textElement = screen.getByText(text);
    // verify element is found
    assertExists(textElement);
    // verify element's text content
    assertEquals(textElement.textContent, text);
  });
});
```
Run `fresh-testing-library` tests like this using this command line:
```bash
deno test --allow-env
```

## Rendering components

The `render` function of `fresh-testing-library` is inherited from Preact Testing Library. It is used to instantiate the component-under-test. Its first argument is required and is the JSX representation of a component including its props.


```
import { render } from "https:/deno.land/x/fresh_testing_library";
const screen = render(<Counter />);
```


## Finding DOM Elements

As stated previously, Testing Library libraries including `fresh-testing-library` focusses on verifying DOM elements generated by the component-under-test.

There are six ways of finding elements in a `fresh-testing-library` test. Three of them (getBy*, queryBy* and findBy*) are used to find single elements. The others (getAllBy*, queryAllBy* and findAllBy*) are used to find a collection of elements

| Finder function | Match Found returns    | Match Not Found returns |
| :-------------: | :--------------------: | :--------------------:  |
| getBy*          | matching node          | throws an error         |
| getAllBy*       | matching node          | throws an error         |
| queryBy*        | matching node          | null                    |
| queryAlBy*      | matching node          | empty array             |
| findBy*         | resolved Promise       | rejected Promise        |
| findAllBy*      | resolved Promise       | rejected Promise        |

Also note that if you are using getBy, queryBy or findBy functions and more than one element is returned, then an error is thrown. Conversely, a getAllBy, queryAllBy and findAllBy function returns an array with a single element if only one matching element exists.

The full name of a finder function specifies how an element is located. Here's what they are with a 'getBy' prefix (the same functions exist using 'queryBy' or 'findBy'):
- `getByAltText` - finds the element using the `alt` attribute
- `getByDisplayValue` - finds the element using the `value` attribute
- `getByLabelText` - finds the element using the `label` attribute. Obviously, this is mostly used to locate form elements
- `getByPlaceholderText` - finds the element using the `placeholder` attribute found in a `text` or `textarea` element.
- `getByRole` - finds the element by it's `role` attribute. This is defined by the ARIA accessibility standard. Use the autocompletion feature of your IDE to discover the available roles and [this list of WAI ARIA roles](https://www.codeinwp.com/blog/wai-aria-roles/) to discover the appropriate role.
- `getByTestId` - finds an element using the `data-testid` attribute
- `getByTitle` - finds an element using the enclosed `title`element. This is best used with an svg graphic that contains a `title` child element.

Note that most of the finder functions use accessibility-related attributes.


Each of these functions accepts a string or regular expression as it's first argument.

## Using getBy or getAllBy

## Using queryBy or queryAllBy

## Using findBy or findALlBy

#### The waitFor function

## Simulating user interactions

## Testing state management

## Testing Fresh route handlers

## Testing Fresh middleware


